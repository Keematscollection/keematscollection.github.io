<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keemat Admin</title>
    <style>
        body { font-family: sans-serif; background: #111; color: white; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .stats-card { background: #222; padding: 20px; border-radius: 10px; margin-bottom: 10px; text-align: center; border: 1px solid #333; }
        .stat-val { font-size: 1.5rem; color: #25D366; font-weight: bold; }
        .stat-label { font-size: 0.8rem; color: #aaa; text-transform: uppercase; }
        .order-card { background: white; color: black; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #25D366; }
        .order-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        .order-id { font-weight: bold; font-size: 1.1rem; }
        .order-total { font-size: 1.2rem; font-weight: bold; text-align: right; margin-top: 10px; }
        input, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 5px; border: none; }
        .btn-action { background: #d4af37; color: black; font-weight: bold; cursor: pointer; }
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:999; display:flex; flex-direction:column; justify-content:center; padding:20px; box-sizing:border-box;}
    </style>
</head>
<body>

<div id="login-overlay">
    <h2 style="text-align:center; color:#d4af37;">ADMIN LOGIN</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button class="btn-action" onclick="login()">LOGIN</button>
</div>

<div class="header"><h3>KEEMAT DASHBOARD</h3><button onclick="logout()" style="width:auto; background:red; color:white;">Logout</button></div>

<div class="stats-card">
    <div class="stat-val" id="monthlyRev">GHS 0.00</div><div class="stat-label">Monthly Revenue</div>
    <hr style="border-color:#333">
    <div class="stat-val" id="annualRev">GHS 0.00</div><div class="stat-label">Annual Revenue</div>
    <div class="stat-val" id="totalOrders" style="color:white; margin-top:10px;">0</div><div class="stat-label">Total Orders</div>
</div>

<button class="btn-action" onclick="window.location.href='melmas_production.html'">GO TO INVENTORY</button>
<button style="background:#333; color:white" onclick="location.reload()">REFRESH</button>
<input type="text" id="searchOrder" placeholder="Search ID, Name or Phone..." onkeyup="filterOrders()">
<div id="ordersList"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAd8obgpkRPfSUMYr8zJfr8MB_Evmy1nNg",
      authDomain: "keematscollection.firebaseapp.com",
      projectId: "keematscollection",
      storageBucket: "keematscollection.firebasestorage.app",
      messagingSenderId: "344751322745",
      appId: "1:344751322745:web:b57abb74c33056a0b886a8",
      measurementId: "G-PPS020WTZ2",
      databaseURL: "https://keematscollection-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const adminUID = "q2LX0nZwGtXMbsW4FKRQztr76eA3";
    let allOrders = [];

    window.login = () => { signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(alert); }
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user && user.uid === adminUID) {
            document.getElementById('login-overlay').style.display = 'none';
            loadOrders();
        } else { document.getElementById('login-overlay').style.display = 'flex'; }
    });

    function loadOrders() {
        onValue(ref(db, 'orders'), (snapshot) => {
            const data = snapshot.val(); allOrders = [];
            if(data) {
                Object.keys(data).forEach(key => allOrders.push(data[key]));
                allOrders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                calculateStats(); renderOrders(allOrders);
            }
        });
    }

    function calculateStats() {
        const now = new Date(); let mR = 0; let yR = 0;
        allOrders.forEach(o => {
            const d = o.timestamp ? new Date(o.timestamp) : now;
            if(d.getFullYear() === now.getFullYear()) { yR += o.totalAmount; if(d.getMonth() === now.getMonth()) mR += o.totalAmount; }
        });
        document.getElementById('monthlyRev').innerText = `GHS ${mR.toFixed(2)}`;
        document.getElementById('annualRev').innerText = `GHS ${yR.toFixed(2)}`;
        document.getElementById('totalOrders').innerText = allOrders.length;
    }

    window.renderOrders = (list) => {
        document.getElementById('ordersList').innerHTML = list.map(o => `
            <div class="order-card">
                <div class="order-header"><span>${o.orderId}</span><span>${o.timestamp ? new Date(o.timestamp).toLocaleString() : ''}</span></div>
                <div class="order-id">${o.customerName}</div>
                <div style="color:#007bff">${o.contact}</div>
                <div style="font-size:0.8rem; margin:5px 0">Loc: ${o.location}</div>
                <div class="order-total">GHS ${o.totalAmount}</div>
            </div>`).join('');
    }

    window.filterOrders = () => {
        const q = document.getElementById('searchOrder').value.toLowerCase();
        renderOrders(allOrders.filter(o => o.orderId.toLowerCase().includes(q) || o.customerName.toLowerCase().includes(q) || o.contact.includes(q)));
    }
</script>
</body>
</html>
