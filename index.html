<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Keemat's Collection</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3081/3081986.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081986.png">
    <meta name="theme-color" content="#000000">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #f9f9f9; overflow-x: hidden; }
        h1, h2, .brand-font { font-family: 'Playfair Display', serif; }
        .gold-accent { color: #D4AF37; }
        .loader { border-top-color: #D4AF37; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fly-item { position: fixed; z-index: 9999; width: 50px; height: 50px; border-radius: 50%; object-fit: cover; pointer-events: none; transition: all 0.8s cubic-bezier(0.1, 0.5, 0.5, 1); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        @keyframes cartShake { 0% { transform: scale(1); } 50% { transform: scale(1.3) rotate(-10deg); } 100% { transform: scale(1); } }
        .cart-animate { animation: cartShake 0.4s ease-in-out; }
        .out-of-stock-img { filter: grayscale(100%); opacity: 0.6; }
        
        .sticky-search {
            position: sticky;
            top: 64px;
            z-index: 40;
            background: rgba(249, 249, 249, 0.9);
            backdrop-filter: blur(5px);
            padding-bottom: 1rem;
        }

        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #25d366;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100;
            transition: all 0.3s ease;
        }
        .help-btn:hover { transform: scale(1.05); background-color: #128c7e; }
    </style>
</head>
<body class="text-gray-800 relative">

    <nav class="bg-black text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-center">
                <h1 class="text-xl tracking-widest brand-font font-bold">KEEMAT'S COLLECTION</h1>
                <p class="text-xs gold-accent tracking-wider uppercase">Quality & Affordability</p>
            </div>
            <div id="cart-icon" class="relative cursor-pointer p-3" onclick="toggleCart()">
                <i class="fas fa-shopping-bag text-2xl gold-accent"></i>
                <span id="cart-count" class="absolute top-0 right-0 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </div>
        </div>
    </nav>

    <a href="https://wa.me/233554011014?text=Hello%20Keemat's%20Collection,%20I%20need%20help/have%20a%20complaint%20regarding..." 
       target="_blank" class="help-btn">
        <i class="fab fa-whatsapp text-xl"></i>
        <span>Help & Complaints</span>
    </a>

    <div class="sticky-search px-6 pt-4">
        <div class="container mx-auto">
            <div class="relative max-w-md mx-auto">
                <input type="text" id="search-input" placeholder="Search products..." class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-full focus:border-black outline-none transition shadow-md bg-white text-base">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
            </div>
        </div>
    </div>

    <div id="products" class="container mx-auto p-6">
        <h2 class="text-3xl text-center mb-8 border-b-2 border-gray-200 pb-2 inline-block">Latest Collection</h2>
        <div id="loader" class="flex justify-center my-10">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
        </div>
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6 relative">
            <button onclick="toggleCart()" class="absolute top-2 right-2 text-gray-500 p-2"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-2xl brand-font mb-4 border-b pb-2">Your Cart</h2>
            <div id="cart-items" class="max-h-60 overflow-y-auto mb-4 border-b border-gray-200 pb-2"></div>
            
            <div class="flex justify-between items-center font-bold text-lg mb-4">
                <div>Total: <span class="gold-accent">GHS <span id="cart-total">0.00</span></span></div>
                <button onclick="clearCart()" class="text-red-600 text-xs font-bold uppercase hover:underline p-2">Clear All</button>
            </div>

            <form id="checkout-form" class="space-y-3">
                <input type="text" id="cust-name" placeholder="Full Name" required class="w-full border p-3 rounded text-base">
                <input type="text" id="cust-loc" placeholder="Delivery Location (City/Town)" required class="w-full border p-3 rounded text-base">
                <input type="tel" id="cust-contact" placeholder="Contact Number" required class="w-full border p-3 rounded text-base">
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mt-4 mb-4">
                    <p class="text-[11px] text-blue-800 leading-tight">
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>Delivery Info:</strong> Tamale deliveries cost <strong>GHS 20</strong>. For locations outside Tamale, costs will be communicated shortly after product payment.
                    </p>
                </div>

                <button type="submit" class="w-full bg-black text-white py-3 rounded font-bold uppercase tracking-widest hover:bg-gray-800 transition">Confirm Order</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAd8obgpkRPfSUMYr8zJfr8MB_Evmy1nNg",
            authDomain: "keematscollection.firebaseapp.com",
            projectId: "keematscollection",
            storageBucket: "keematscollection.firebasestorage.app",
            messagingSenderId: "344751322745",
            appId: "1:344751322745:web:b57abb74c33056a0b886a8",
            measurementId: "G-PPS020WTZ2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let products = [];
        let cart = [];

        async function loadProducts() {
            try {
                const snap = await getDocs(collection(db, "products"));
                document.getElementById('loader').style.display = 'none';
                snap.forEach(doc => {
                    const data = doc.data();
                    products.push({ id: doc.id, ...data });
                    renderProduct(doc.id, data);
                });
            } catch (err) { 
                console.error(err); 
                document.getElementById('loader').style.display = 'none'; // Hide loader on error
            }
        }

        function renderProduct(id, data) {
            // SAFETY PATCH: Skip items missing a name to prevent site crashes
            if (!data.name) return;

            const grid = document.getElementById('product-grid');
            const isOut = data.stock <= 0;
            const card = document.createElement('div');
            card.className = "product-card bg-white shadow-md rounded-lg overflow-hidden flex flex-col relative";
            card.dataset.name = data.name.toLowerCase();
            
            card.innerHTML = `
                <div class="relative w-full">
                    <img id="img-${id}" src="${data.image}" onerror="this.src='https://via.placeholder.com/300?text=No+Image'" class="h-48 w-full object-cover ${isOut ? 'out-of-stock-img' : ''}">
                    ${isOut ? '<span class="absolute top-2 left-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded">OUT OF STOCK</span>' : ''}
                </div>
                <div class="p-4 flex flex-col flex-grow">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-bold text-md leading-tight">${data.name}</h3>
                        <button onclick="shareProduct('${data.name}', '${data.price}')" class="text-gray-400 hover:text-black transition p-2 -mt-2 -mr-2">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 italic mb-2 line-clamp-2">${data.description || ''}</p>
                    
                    <p class="text-lg font-bold gold-accent mb-3">GHS ${data.price}</p>
                    <div class="mt-auto">
                        <div class="flex items-center justify-between mb-3 ${isOut ? 'hidden' : ''}">
                            <span class="text-xs text-gray-500 uppercase font-bold">Qty:</span>
                            <div class="flex items-center border rounded">
                                <button onclick="changeQtyUI('${id}', -1)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200">-</button>
                                <span id="qty-${id}" class="px-3 font-bold text-sm">1</span>
                                <button onclick="changeQtyUI('${id}', 1)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200">+</button>
                            </div>
                        </div>
                        <button onclick="addToCart('${id}')" ${isOut ? 'disabled' : ''}
                            class="w-full ${isOut ? 'bg-gray-400' : 'bg-black hover:bg-gray-800'} text-white py-3 text-sm rounded font-bold transition">
                            ${isOut ? 'UNAVAILABLE' : 'ADD TO CART'}
                        </button>
                    </div>
                </div>`;
            grid.appendChild(card);
        }

        window.shareProduct = async (name, price) => {
            const shareData = {
                title: "Keemat's Collection",
                text: `Check out this ${name} for only GHS ${price} at Keemat's Collection!`,
                url: window.location.href
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareData.text + " " + shareData.url)}`;
                    window.open(whatsappUrl, '_blank');
                }
            } catch (err) { console.log('Share cancelled or failed'); }
        };

        window.changeQtyUI = (id, delta) => {
            const el = document.getElementById(`qty-${id}`);
            let val = parseInt(el.innerText) + delta;
            if (val < 1) val = 1;
            el.innerText = val;
        };

        window.addToCart = (id) => {
            const p = products.find(x => x.id === id);
            const qtyInput = document.getElementById(`qty-${id}`);
            const qty = parseInt(qtyInput ? qtyInput.innerText : 1);
            
            flyToCart(document.getElementById(`img-${id}`));

            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.qty += qty;
            } else {
                cart.push({ ...p, qty: qty });
            }

            setTimeout(() => { updateCartUI(); animateCartIcon(); }, 800);
        };

        function updateCartUI() {
            const count = cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cart-count').innerText = count;
            
            const list = document.getElementById('cart-items');
            if (cart.length === 0) {
                list.innerHTML = '<p class="text-center py-4 text-gray-400">Your cart is empty</p>';
            } else {
                list.innerHTML = cart.map(item => `
                    <div class="flex justify-between items-center text-sm mb-3 border-b pb-2">
                        <div class="flex flex-col">
                            <span class="font-bold">${item.name}</span>
                            <span class="text-xs text-gray-500">GHS ${item.price} x ${item.qty}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="font-bold mr-2">GHS ${(item.price * item.qty).toFixed(2)}</span>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-500 p-2"><i class="fas fa-trash text-sm"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('cart-total').innerText = total.toFixed(2);
        }

        window.removeFromCart = (id) => {
            cart = cart.filter(item => item.id !== id);
            updateCartUI();
        };

        window.clearCart = () => { if(confirm("Empty cart?")) { cart = []; updateCartUI(); } };

        function flyToCart(img) {
            const icon = document.getElementById('cart-icon');
            const fly = img.cloneNode();
            const r = img.getBoundingClientRect();
            const cr = icon.getBoundingClientRect();
            fly.className = "fly-item";
            fly.style.cssText = `top:${r.top}px; left:${r.left}px; width:${r.width}px; height:${r.height}px;`;
            document.body.appendChild(fly);
            requestAnimationFrame(() => {
                fly.style.cssText = `top:${cr.top}px; left:${cr.left}px; width:20px; height:20px; opacity:0;`;
            });
            setTimeout(() => fly.remove(), 800);
        }

        function animateCartIcon() {
            const icon = document.getElementById('cart-icon');
            icon.classList.add('cart-animate');
            setTimeout(() => icon.classList.remove('cart-animate'), 400);
        }

        window.toggleCart = () => document.getElementById('checkout-modal').classList.toggle('hidden');

        document.getElementById('search-input').onkeyup = (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('.product-card').forEach(c => {
                c.style.display = c.dataset.name.includes(q) ? 'flex' : 'none';
            });
        };

        document.getElementById('checkout-form').onsubmit = (e) => {
            e.preventDefault();
            if(cart.length === 0) return alert("Cart is empty");
            
            const name = document.getElementById('cust-name').value;
            const loc = document.getElementById('cust-loc').value;
            const items = cart.map(i => `- ${i.name} (x${i.qty})`).join('%0a');
            const total = document.getElementById('cart-total').innerText;
            
            const msg = `*NEW ORDER @ KEEMAT'S*%0aName: ${name}%0aLocation: ${loc}%0aItems:%0a${items}%0aTotal: GHS ${total}%0a%0a_Note: Delivery within Tamale is GHS 20. Other locations will be discussed after payment._`;
            
            window.open(`https://wa.me/233554011014?text=${msg}`, '_blank');
            
            // GOODBYE MESSAGE ADDED HERE
            setTimeout(() => {
                alert(`Thank you for shopping with Keemat's Collection, ${name}! Your order has been sent. We look forward to serving you again soon! âœ¨`);
            }, 500);

            cart = []; updateCartUI(); toggleCart();
        };

        loadProducts();
    </script>
</body>
</html>
